# Implementation Tasks

## 1. 项目初始化
- [x] 1.1 创建 Cargo 项目结构
- [x] 1.2 配置 Cargo.toml 依赖
- [x] 1.3 设置基础错误类型和结果类型
- [x] 1.4 创建项目 README
- [x] 1.5 设置测试框架

## 2. 词法分析器 (Tokenizer)
- [x] 2.1 定义 Token 枚举类型
- [x] 2.2 定义所有保留字 (27个语句关键字)
- [x] 2.3 定义所有函数名 (22个内置函数)
- [x] 2.4 定义运算符 token
- [x] 2.5 定义分隔符 token (冒号、逗号、分号)
- [x] 2.6 实现数字常量识别 (整数和浮点数)
- [x] 2.7 实现标识符识别 (变量名、行号)
- [x] 2.8 实现字符串常量识别
- [x] 2.9 处理空格和注释
- [x] 2.10 实现行号解析
- [x] 2.11 实现冒号作为语句分隔符的识别
- [x] 2.12 编写词法分析器单元测试（包括分隔符）

## 3. 语法解析器 (Parser)
- [x] 3.1 定义抽象语法树 (AST) 数据结构
- [x] 3.2 实现表达式解析 (递归下降或优先级攀升)
- [x] 3.3 实现语句解析器基础框架
- [x] 3.4 解析简单语句 (LET, PRINT, REM, END)
- [x] 3.5 解析流程控制语句 (GOTO, IF)
- [x] 3.6 解析循环语句 (FOR...NEXT)
- [x] 3.7 解析子程序调用 (GOSUB, RETURN)
- [x] 3.8 解析数组和函数调用
- [x] 3.9 实现冒号分隔的单行多语句解析
- [x] 3.10 实现单行 FOR 循环（FOR...NEXT 在一行内）
- [x] 3.11 实现单行嵌套 FOR 循环支持
- [ ] 3.12 实现错误恢复机制
- [x] 3.13 编写解析器单元测试（包括单行多语句）

## 4. 运行时环境 (Runtime)
- [x] 4.1 定义程序状态结构
- [x] 4.2 实现程序行存储和索引
- [x] 4.3 实现程序计数器和行号跳转
- [x] 4.4 实现 GOSUB 栈管理
- [x] 4.5 实现 FOR 循环栈管理
- [x] 4.6 实现直接模式 vs 程序模式
- [x] 4.7 实现 NEW 命令 (清空程序)
- [x] 4.8 实现 LIST 命令 (列出程序)
- [x] 4.9 实现 RUN 命令
- [x] 4.10 实现 STOP, END, CONT 命令
- [x] 4.11 编写运行时单元测试

## 5. 变量系统 (Variables)
- [x] 5.1 定义变量值类型 (整数、浮点、字符串)
- [x] 5.2 实现变量名解析 (A-Z, A0-Z9, A-Z$)
- [x] 5.3 实现简单变量存储 (HashMap)
- [x] 5.4 实现数组变量存储
- [x] 5.5 实现 DIM 语句
- [x] 5.6 实现数组边界检查
- [x] 5.7 实现多维数组支持
- [x] 5.8 实现变量类型检查
- [x] 5.9 实现 CLEAR 命令 (清空变量)
- [x] 5.10 编写变量系统单元测试

## 6. 基础执行引擎 (Executor)
- [x] 6.1 创建 Executor 结构
- [x] 6.2 表达式求值器实现
- [x] 6.3 算术运算符 (+, -, *, /, ^)
- [x] 6.4 关系运算符 (=, <>, <, >, <=, >=)
- [x] 6.5 逻辑运算符 (AND, OR, NOT)
- [x] 6.6 字符串运算 (连接、比较)
- [x] 6.7 内置数学函数 (SGN, INT, ABS, SQR, SIN, COS, TAN, ATN, LOG, EXP)
- [x] 6.8 内置字符串函数 (LEN, ASC, CHR$, STR$, VAL, LEFT$, RIGHT$, MID$)
- [x] 6.9 基础语句执行 (LET, DIM, END, STOP, NEW, CLEAR)
- [x] 6.10 变量和数组访问
- [x] 6.11 编写执行引擎单元测试 (17 个测试)

## 6B. 完善语句执行 (Advanced Statements)
- [x] 6B.1 PRINT 语句 (基础输出)
- [x] 6B.2 PRINT 使用分隔符 (逗号、分号)
- [x] 6B.3 PRINT TAB() 和 SPC() 函数
- [x] 6B.4 REM 语句 (注释 - 已在解析器中支持)
- [x] 6B.5 GOTO 语句
- [x] 6B.6 IF...THEN 语句（包括 THEN 后跟行号或语句）
- [x] 6B.7 GOSUB 和 RETURN 语句
- [x] 6B.8 ON...GOTO 和 ON...GOSUB 语句
- [x] 6B.9 FOR...NEXT 语句
- [x] 6B.10 FOR...STEP 支持
- [x] 6B.11 测试所有高级语句（已完成 20 个测试）

## 7. 运算符实现 (已在 Executor 中实现)
- [x] 7.1 算术运算符 (+, -, *, /)
- [x] 7.2 乘方运算符 (^)
- [x] 7.3 一元负号 (-)
- [x] 7.4 关系运算符 (=, <>, <, >, <=, >=)
- [x] 7.5 逻辑运算符 (AND, OR, NOT)
- [x] 7.6 字符串连接 (+)
- [x] 7.7 运算符优先级处理 (已在 Parser 中)
- [x] 7.8 类型转换和检查
- [x] 7.9 测试所有运算符

## 8. 浮点运算 (Float Arithmetic) - 基本完成
- [x] 8.1 选择浮点数表示 (f64)
- [x] 8.2 实现加法和减法
- [x] 8.3 实现乘法和除法
- [x] 8.4 实现乘方运算
- [x] 8.5 实现数值比较
- [x] 8.6 实现整数和浮点转换
- [x] 8.7 实现浮点数输入解析 (已在 Tokenizer 中)
- [ ] 8.8 实现浮点数输出格式化 (需在 PRINT 中完善)
- [ ] 8.9 处理溢出和下溢
- [x] 8.10 测试浮点运算精度

## 9. 数学函数 (已在 Executor 中实现)
- [x] 9.1 SGN(x) - 符号函数
- [x] 9.2 INT(x) - 取整函数
- [x] 9.3 ABS(x) - 绝对值
- [x] 9.4 SQR(x) - 平方根
- [x] 9.5 EXP(x) - 指数函数
- [x] 9.6 LOG(x) - 自然对数
- [x] 9.7 SIN(x), COS(x), TAN(x) - 三角函数
- [x] 9.8 ATN(x) - 反正切
- [x] 9.9 RND(x) - 随机数
- [x] 9.10 测试所有数学函数

## 10. 字符串功能 (已在 Variables 和 Executor 中实现)
- [x] 10.1 字符串变量存储
- [x] 10.2 字符串连接操作
- [x] 10.3 LEN(s$) - 字符串长度
- [x] 10.4 LEFT$(s$, n) - 左子串
- [x] 10.5 RIGHT$(s$, n) - 右子串
- [x] 10.6 MID$(s$, n[, m]) - 中间子串
- [x] 10.7 STR$(x) - 数字转字符串
- [x] 10.8 VAL(s$) - 字符串转数字
- [x] 10.9 ASC(s$) - 字符 ASCII 码
- [x] 10.10 CHR$(x) - ASCII 码转字符
- [x] 10.11 字符串比较
- [x] 10.12 测试所有字符串函数

## 11. 输入输出 (I/O)
- [x] 11.1 实现基础 INPUT 语句
- [x] 11.2 INPUT 提示符支持
- [x] 11.3 INPUT 多个变量
- [x] 11.4 INPUT 错误处理和重试
- [x] 11.5 实现 DATA 语句
- [x] 11.6 实现 READ 语句
- [x] 11.7 实现 RESTORE 语句
- [x] 11.8 集成 rustyline 行编辑
- [x] 11.9 实现命令历史
- [x] 11.10 测试 I/O 功能（10 个测试）

## 12. 系统函数
- [ ] 12.1 FRE(x) - 剩余内存
- [ ] 12.2 POS(x) - 光标位置
- [ ] 12.3 PEEK(addr) - 读内存 (模拟)
- [ ] 12.4 POKE addr, value - 写内存 (模拟)
- [ ] 12.5 WAIT 语句
- [ ] 12.6 测试系统函数

## 13. 用户自定义函数
- [ ] 13.1 DEF FN 语句解析
- [ ] 13.2 单行函数定义
- [ ] 13.3 函数调用 FN name(arg)
- [ ] 13.4 函数作用域管理
- [ ] 13.5 测试用户定义函数

## 14. 错误处理
- [x] 14.1 定义所有错误类型
- [x] 14.2 实现错误消息 (中文/英文)
- [x] 14.3 语法错误报告 (行号、位置)
- [x] 14.4 运行时错误处理
- [x] 14.5 STOP 和 END 的区别（END结束，STOP暂停）
- [x] 14.6 CONT 命令恢复执行
- [x] 14.7 实现 Ctrl+C 中断处理（捕获 ReadlineError::Interrupted）
- [x] 14.8 Ctrl+C 中断后保存执行状态（Paused状态包含行号、位置）
- [x] 14.9 确保 CONT 可以从 Ctrl+C 中断点继续执行（continue_execution）
- [x] 14.10 测试 Ctrl+C 中断和恢复流程（在 REPL 中测试）
- [x] 14.11 测试其他错误处理场景（已有 168 个测试）
- [x] 14.12 实现程序执行期间的 Ctrl+C 信号处理（添加 ctrlc crate，使用 Arc<AtomicBool> 在执行循环中检查中断标志）
- [x] 14.13 完善 Ctrl+C 中断机制（在长循环执行时可中断，显示 ?BREAK IN 行号，可用 CONT 继续）

## 15. 交互模式
- [x] 15.1 REPL 主循环（rustyline 集成）
- [x] 15.2 直接模式命令执行（process_line）
- [x] 15.3 程序编辑 (输入行号添加/修改程序行)
- [x] 15.4 行删除 (输入空行删除指定行)
- [x] 15.5 LIST 命令变体 (LIST, LIST 10, LIST 10-50)
- [x] 15.6 启动横幅和提示符（显示 "Ready."）
- [x] 15.7 退出命令（Ctrl+D / EOF）
- [x] 15.8 测试交互模式（手动测试通过）
- [x] 15.9 优化提示符显示（修复换行问题，使用 println 手动打印提示符，rustyline 提示符设为空）
- [x] 15.10 统一提示符（定义 PROMPT 常量为 "READY."，所有提示符引用统一使用该常量）

## 16. 高级功能 (可选)
- [x] 16.1 LOAD 命令 (从文件加载程序)
- [x] 16.2 SAVE 命令 (保存程序到文件)
- [ ] 16.3 GET 语句 (单字符输入)
- [ ] 16.4 NULL 语句
- [ ] 16.5 CMD 和 SYS 语句
- [x] 16.6 文件格式定义（文本格式，可重新解析）
- [x] 16.7 测试文件操作

## 17. 集成测试
- [ ] 17.1 简单程序测试 (Hello World)
- [ ] 17.2 循环测试 (求和、阶乘)
- [ ] 17.3 数组测试 (排序、搜索)
- [ ] 17.4 字符串处理测试
- [ ] 17.5 子程序测试
- [ ] 17.6 递归函数测试
- [ ] 17.7 经典游戏测试 (猜数字、星际迷航)
- [ ] 17.8 数学计算测试
- [ ] 17.9 综合测试程序
- [ ] 17.10 性能基准测试

## 18. 文档和完善
- [ ] 18.1 完善代码注释
- [ ] 18.2 编写用户手册
- [ ] 18.3 编写开发者文档
- [ ] 18.4 添加使用示例
- [ ] 18.5 优化错误消息
- [ ] 18.6 代码重构和清理
- [ ] 18.7 性能分析和优化
- [ ] 18.8 最终测试

## 19. 部署和发布
- [ ] 19.1 配置 CI/CD
- [ ] 19.2 创建发布版本
- [ ] 19.3 编写 CHANGELOG
- [ ] 19.4 准备示例程序
- [ ] 19.5 发布第一个版本

